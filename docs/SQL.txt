CREATE DATABASE IF NOT EXISTS StudyTracker;
USE StudyTracker;

SET FOREIGN_KEY_CHECKS = 0;
DROP TABLE IF EXISTS seja;
DROP TABLE IF EXISTS poglavje;
DROP TABLE IF EXISTS predmet;
DROP TABLE IF EXISTS oseba;
DROP TABLE IF EXISTS tip_osebe;
SET FOREIGN_KEY_CHECKS = 1;

CREATE TABLE tip_osebe (
                           id_tip_osebe        INT PRIMARY KEY AUTO_INCREMENT,
                           naziv               VARCHAR(50) NOT NULL
);

CREATE TABLE oseba (
                       id_osebe         INT PRIMARY KEY AUTO_INCREMENT,
                       ime              VARCHAR(80)  NOT NULL,
                       priimek          VARCHAR(80)  NOT NULL,
                       email            VARCHAR(255) UNIQUE,
                       uporabnisko_ime  VARCHAR(60)  NOT NULL UNIQUE,
                       geslo_hash       VARCHAR(255) NOT NULL,
                       datum_prijave    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                       TK_tip_osebe     INT NOT NULL,

                       CONSTRAINT tk_oseba_tip FOREIGN KEY (TK_tip_osebe) REFERENCES tip_osebe(id_tip_osebe)
                           ON UPDATE CASCADE
                           ON DELETE RESTRICT
);

CREATE TABLE predmet (
                         id_predmeta        INT PRIMARY KEY AUTO_INCREMENT,
                         ime                VARCHAR(120) NOT NULL,
                         datum_ustanovitve  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                         datum_zakljucka    DATE NOT NULL,
                         TK_oseba           INT NOT NULL,

                         CONSTRAINT tk_predmet_oseba FOREIGN KEY (TK_oseba) REFERENCES oseba(id_osebe)
                             ON UPDATE CASCADE
                             ON DELETE CASCADE
);

CREATE TABLE poglavje (
                          id_poglavja        INT PRIMARY KEY AUTO_INCREMENT,
                          ime                VARCHAR(120) NOT NULL,
                          datum_ustanovitve  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                          TK_predmet         INT NOT NULL,

                          CONSTRAINT fk_poglavje_predmet FOREIGN KEY (TK_predmet) REFERENCES predmet(id_predmeta)
                              ON UPDATE CASCADE
                              ON DELETE CASCADE
);

CREATE TABLE seja (
                      id_seje        INT PRIMARY KEY AUTO_INCREMENT,
                      zacetek        DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                      trajanje_min   INT NOT NULL CHECK (trajanje_min >= 0),
                      TK_osebe       INT NOT NULL,
                      TK_predmeta    INT NOT NULL,
                      TK_poglavje    INT NULL,

                      CONSTRAINT tk_seja_oseba FOREIGN KEY (TK_osebe) REFERENCES oseba(id_osebe)
                          ON UPDATE CASCADE
                          ON DELETE CASCADE,

                      CONSTRAINT tk_seja_predmet FOREIGN KEY (TK_predmeta) REFERENCES predmet(id_predmeta)
                          ON UPDATE CASCADE
                          ON DELETE RESTRICT,

                      CONSTRAINT tk_seja_poglavje FOREIGN KEY (TK_poglavje) REFERENCES poglavje(id_poglavja)
                          ON UPDATE CASCADE
                          ON DELETE SET NULL
);

INSERT INTO tip_osebe (naziv) VALUES
                                  ('email_yes'),
                                  ('email_no');

INSERT INTO oseba (ime, priimek, email, uporabnisko_ime, geslo_hash, TK_tip_osebe) VALUES

                                                                                       ('Janez', 'Novak', 'janez@example.com', 'janez', 'hash1', 1),
                                                                                       ('Martin', 'Krpan', 'martin@example.com', 'martin', 'hash2', 2),
                                                                                       ('Pika', 'Nogavicka', 'pika@example.com', 'pika', 'hash3', 1);

INSERT INTO predmet (TK_oseba, ime, datum_ustanovitve, datum_zakljucka) VALUES

                                                                            (1, 'Programiranje', '2025-09-01', '2025-11-30'),
                                                                            (1, 'Podatkovne baze', '2025-09-10', '2025-12-15'),
                                                                            (2, 'Statistika', '2025-09-15', '2025-12-10'),
                                                                            (3, 'Računalniška omrežja', '2025-10-01', '2025-12-31'),
                                                                            (3, 'Umetna inteligenca', '2025-10-05', '2026-01-10');

INSERT INTO poglavje (TK_predmet, ime, datum_ustanovitve) VALUES

-- Programiranje
(1, 'Osnove Pythona', '2025-09-02'),
(1, 'Zanke in pogoji', '2025-09-05'),

-- Podatkovne baze
(2, 'Osnove SQL', '2025-09-12'),
(2, 'Relacijski model', '2025-09-15'),

-- Statistika
(3, 'Opisna statistika', '2025-09-20'),

-- Računalniška omrežja
(4, 'TCP/IP', '2025-10-02'),
(4, 'OSI model', '2025-10-05'),

-- Umetna inteligenca
(5, 'Uvod v AI', '2025-10-06'),
(5, 'Strojno učenje', '2025-10-10');

INSERT INTO seja (zacetek, trajanje_min, TK_osebe, TK_predmeta, TK_poglavje) VALUES

-- Janez
('2025-10-20 09:00:00', 60, 1, 1, 1),
('2025-10-21 14:30:00', 45, 1, 1, 2),
('2025-10-22 10:00:00', 90, 1, 2, 3),

-- Martin
('2025-10-20 08:00:00', 30, 2, 3, 5),
('2025-10-21 18:00:00', 40, 2, 3, 5),

-- Pika
('2025-10-19 19:00:00', 50, 3, 4, 6),
('2025-10-20 11:00:00', 60, 3, 5, 9),
('2025-10-21 12:00:00', 75, 3, 5, 9);
